<root>
    <in>
        position3f
        texcoord2f
        normal_tangent
    </in>
    <out>
        position4f
        texcoord2f
        normalmap
    </out>
    <uniform>
        PhongLight light;
        WorldMatrix world;
    </uniform>
    <raw>
        PushConstant3D
        Normal
    </raw>

    <main>
        out_Position=pc.local_to_world*vec4(Position,1.0);
        out_TexCoord=TexCoord;

        mat3 normal_matrix=GetWorldNormalMatrix();

        vec3 T=normalize(normal_matrix*Tangent);
        vec3 N=normalize(normal_matrix*Normal);

        T = normalize(T - dot(T, N) * N);
        vec3 B = cross(N, T);
    
        mat3 TBN = transpose(mat3(T, B, N));

        out_TangentLightPos = TBN * light.position;
        out_TangentViewPos  = TBN * world.view_pos;
        out_TangentFragPos  = TBN * out_Position.xyz;

        gl_Position=world.mvp*out_Position;
    </main>
</root>
